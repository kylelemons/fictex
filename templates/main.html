<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>FicTeX - Fiction Formatting</title>
  <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.js"></script>
  <script type='text/javascript' src="https://ajax.googleapis.com/ajax/libs/jqueryui/1/jquery-ui.js"></script>
  <link rel="stylesheet" type='text/css' href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/base/jquery-ui.css" />
  <style type='text/css'>
    * {
      padding: 0;
      margin: 0;
    }

    body {
      font-size: 10pt;
    }

    /* JQuery UI Overrides */
    .ui-widget {
      font-size: 10pt;
    }

    /* My Fiction list */
    .myfic {
      position: absolute;
      /* 100% height, 255px width, 10px padding */
      top: 10px;
      left: 10px;
      bottom: 10px;
      width: 235px;
    }

    .ficlist {
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;

      padding: 10px;
      overflow: auto;
    }

    /* Current Fiction */
    .current {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 250px;
    }

    /* Editor */
    .top {
      position: absolute;

      top: 0;
      left: 0;
      right: 0;
      height: 40%;
    }

    .editor {
      position: absolute;

      top: 10px;
      left: 10px;
      right: 10px;
      bottom: 10px;
      padding: 5px;

    }

    .editor textarea {
      width: 100%;
      height: 100%;
      border: none;
      outline: none;
    }

    /* Options */
    .options {
      padding: 5px;
      text-align: center;
    }

    .outputformat, .displaystyle {
      display: inline-block;
    }

    .options * {
      font-size: 8pt;
    }

    /* Preview */
    .bottom {
      position: absolute;
      top: 40%;
      width: 100%;
      height: 60%;
    }

    .panes {
      position: absolute;
      top: 40px;
      bottom: 10px;
      left: 10px;
      right: 10px;
    }

    .pane {
      position: absolute;
      top: 0px;
      bottom: 0px;
      left: 0px;
      right: 0px;

      padding: 10px;
      overflow: auto;
    }

    /* General styling */

    p {
      text-indent: 1em;
      padding: 3px 0px;
    }

    hr {
      margin: 15px 40%;
    }

    .pre {
      font-family: monospace;
      white-space: pre-wrap;
    }

    .border {
      border-width: 1px;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: sans-serif;
    }

    h1 { font-size: 16pt; }
    h2 { font-size: 14pt; }
    h3 { font-size: 13pt; }
    h4 { font-size: 12pt; }
    h5 { font-size: 11pt; }
    h6 { font-size: 10pt; }

  </style>
</head>
<body>
  <div class='myfic'>
    <div class='ficlist border'>
      <h1>Stories</h1>
      <ul>
        <li>
        </li>
      </ul>
    </div>
  </div>
  <div class='current'>
    <div class='top'>
      <div class='editor border'>
        <textarea id='source' rows='12' cols='32'>{{.Saved}}</textarea>
      </div>
    </div>
    <div class='bottom'>
      <div class='options'>
        <div class='displaystyle'>
          <input type='radio' name='display' id='meta' /><label for='meta'>Info</label>
          <input type='radio' name='display' id='fmt' checked='checked' /><label for='fmt'>Preview</label>
          <input type='radio' name='display' id='raw' /><label for='raw'>View Source</label>
        </div>
        <div class='outputformat'>
          <input type='radio' name='format' id='text' /><label for='text'>Text</label>
          <input type='radio' name='format' id='html' /><label for='html'>HTML</label>
          <input type='radio' name='format' id='lj' checked='checked' /><label for='lj'>LiveJournal</label>
          <input type='radio' name='format' id='bbcode' /><label for='bbcode'>BBCode</label>
        </div>
      </div>
      <div class='panes'>
        <div class='border pane' id='metapane'>
          <div class='metadata'>
            <h1 id='title'>Untitled Story</h1>
          </div>
        </div>
        <div class='border pane' id='fmtpane'>{{.SavedHTML}}</div>
        <div class='border pane pre' id='rawpane'>{{.SavedSource}}</div>
      </div>
    </div>
  </div>
  <script type='text/javascript'>
  var throttle = false;
  var pause = false;
  var waitms = 100;

  var pending = false;

  function radioval(name) {
    return $('input[name='+name+']:checked').attr('id');
  }

  function pane() {
    var display = radioval('display');
    $('.pane').hide();
    $('#'+display+'pane').show();
  }

  function sync() {
    var format = radioval('format');

    if (pending) {
      console.log("Ajax request still pending");
      return;
    }
    pending = true;

    var text = $('#source').val();
    var jqXHR = $.post('/read', { action: "render", source: text })
    
    jqXHR.done(function(data) {
      pending = false;
      $('#rawpane').text(data);
      $('#fmtpane').html(data);
    });

    jqXHR.always(function() {
      pending = false;
    })
  }

  function save() {
    var text = $('#source').val();
    var jqXHR = $.post('/save', { source: text })
    
    jqXHR.fail(function() {
      console.log('Failed to save');
    });
  }

  $(function() {
    $('#source').keyup(function(ev) {
      if (throttle) {
        if (pause) {
          return;
        }
        pause = true;
        setTimeout('pause = false', waitms);
      }
      if (ev.which == $.ui.keyCode.PERIOD || ev.which == $.ui.keyCode.ENTER) {
        save();
      }

      sync();
    });

    // Style some things nicely
    $('.border').addClass('ui-corner-all').addClass('ui-widget-content')

    $('.outputformat').buttonset();
    $('.displaystyle').buttonset();
    $('input[name=display]').change(pane);
    $('input[name=format]').change(sync);

    pane()
  })
  </script>
</body>
</html>
